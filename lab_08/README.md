# Алгоритм отсечения отрезка произвольным выпуклым отсекателем (Алгоритм Кируса-Бека)

Главным отличием данного алгоритма, от рассмотренных ранее является то, что отсекатель может иметь любую выпуклую форму. Для определения местоположения конца отрезка относительно окна отсечения используется вектор нормали и параметрическая форма задания отрезка 

P(t) = P1 + (P2 – P1)t, где  0 ≤ t ≤ 1

Внутрення нормаль n для любой стороны отсекателя удовлетворяет условию nв * (B - A) >= 0, где A – это точка на стороне, а B – это точка на любой из сторон отсекателя. В действительности, угол между нормалью и BA будет принимать значения между -90 и 90. Граничные значения принимает только тогда, когда B и A лежат на одной стороне (или, если на двух сторонах, которые лежат на одной прямой).

Пусть для i-й стороны отсекателя fi – граничная точка и nвi – внутренняя нормаль к этой стороне. Тогда, для 0 ≤ t ≤ 1 и nвi * (P(t) - fi) получим:

1. Больше 0, если точка будет внутри отсекателя

2. Равно 0, если точка будет на границе отсекателя

3. Меньше 0, если точка будет вне отсекателя

Подставив P(t), получим: nвi * (P1 + (P2 – P1) * t - fi), где 0 ≤ t ≤ 1

Исходя из свойств скалярного произведения, уравнение можно переписать:

nвi * [P1 - fi] + nвi [P2 – P1] * t = nвi * Wi + nвi * D * t, где Wi – коэффициент, D – вектор ориентации отрезка P1P2

Тогда, чтобы найти точку пересечения отрезка с очередной i-ой стороной отсекателя, необходимо решить уравнение nвi * Wi + nвi * D * t = 0. 

Тогда, получим: t = - (nвi * Wi)/(nвi * D), при D ≠ 0, i = (1,2…m)

Решение может не лежать в диапазоне от 0 до 1, в таком случае точка пересечения будет находится вне исходного отрезка. Однако, данное уравнение может иметь более двух решений в интервале. В этих случаях решение нужно разбить на две группы в зависимости от их удалённости от концов отрезка. В этом случае границы отсечённого отрезка представляются значениями параметра t:

1. tminmax – макс. значение из нижней группы

2. tmaxmin – мин. значение из верхней группы

Исходя из вышеописанного, можно выстроить логику работы алгоритма:

Проверяется видимость отрезка: D = 0 (отрезок вырождается в точку или параллелен стороне отсекателя). В таком случае, для проверки видимости, необходимо рассмотреть положение произвольной точки полученного отрезка (или точку в которую выродился отрезок) и проверить знак скалярного произведения Wi. Если  (t > 0 и D > 0) или (t < 0 и D < 0) – пересечение отрезка со стороной отсекателя лежит на продолжении этого отрезка, при этом сам отрезок  направлен в другую противоположную сторону. 

Для каждой стороны отсекателя производится проверка видимости, при этом нужно обновлять значения tminmax и tmaxmin. 

В том случае, если отрезок видим, то необходимо проверить валидность значений и изобразить его. 

Для правильной работы программы, необходима проверка на выпуклость отсекателя перед началом выполнения алгоритма. Для этого все смежные стороны отсекателя должны иметь один знак векторного произведения, что обеспечивает одно направление расположения сторон.  

# Возможные вопросы на защиту и попытка на них ответить

#### 1. Возьмите в качестве отсекателя прямоугольник и покажите все невидимые отрезки, невидимость которых определяется всеми разными способами. (жду рисунок и краткое, но полное объяснение) (вопрос в условиях дистанта, может быть не задаст, а может и задаст).

![](https://sun9-4.userapi.com/BEMXCtY5DsvMIy5ESfYw2sGQqbZKry6ptahlzA/WI_2NcA2yKA.jpg)

- Отрезок 12, D > 0, t > 1, следовательно прямая на которой лежит данный отрезок могла бы пересечь отсекатель, но, т.к. t > 1 и при этом он не станет меньше, получаем, что отрезок невидим.

- Отрезок 34 будет пересекаться с продолжениями сторон отсекателя, тогда в ходе работы алгоритма получим, что для левой стороны пересечение будет tn, а для следующей tv. На моменте проверки tn < tv получим, что отрезок станет невидимым по окончании цикла по рёбрам.

- Отрезок 56 направлен в противоположном направлении от нормали стороны отсекателя, поэтому D < 0. При обработке отрезка выясним, что t < 0, следовательно отрезок выше отсекателя и невидим, т.к. t не увеличится.

- Отрезок 89 будет параллелен стороне отсекателя, и все точки отрезка будут находится вне отсекателя, где D = 0, Wi < 0.

- Точка 7 - вырожденный в точку отрезок, при этом D = 0. Так как Wi будет меньше 0, то данная точка находится вне отсекателя (вектор от произвольной точки стороны будет иметь тупой угол с нормалью стороны).

#### 2. Как определяется полная видимость отрезка?

В случае полностью видимого отрезка, его позиция будет находится внутри отсекателя для каждого отрезка (скалярное произведение (nв; P(t) - f) будет > 0). Также для каждого из этих отрезков пересечение с отсекателем будет находится на продолжениях, поэтому начальные значения tn и tv не изменятся и будут иметь соответствующие полной видимости отрезка значения 0 и 1.

#### 3. Как определяли нужное направление нормали?

При проверке на выпуклость, в моей программе определяется направление обхода и если направление по часовой стрелке, то нормаль имеет вид (-dy, dx), если против часовой, то (dy, -dx), т.к. направление нормали должно "совпадать" с направлением обхода по x, т.е. идити к центру.
